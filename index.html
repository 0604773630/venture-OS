<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venture-OS | Synchronized Startup Architecture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        space: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            800: '#1e293b',
                            900: '#0a0a0f',
                            950: '#020617', // Deep Space
                        },
                        cyan: {
                            400: '#22d3ee',
                            500: '#06b6d4',
                            900: '#083344',
                        },
                        gold: {
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.6s ease-out forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'bounce-subtle': 'bounceSubtle 2s infinite',
                        'thinking': 'thinkingPulse 2s infinite',
                        'brain-wave': 'brainWave 1.5s infinite linear',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        bounceSubtle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        },
                        thinkingPulse: {
                            '0%, 100%': { borderColor: 'rgba(168, 85, 247, 0.2)', boxShadow: '0 0 0 0 rgba(168, 85, 247, 0)' },
                            '50%': { borderColor: 'rgba(168, 85, 247, 0.8)', boxShadow: '0 0 20px 0 rgba(168, 85, 247, 0.4)' }
                        },
                        brainWave: {
                            '0%': { backgroundPosition: '0% 50%' },
                            '100%': { backgroundPosition: '100% 50%' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            /* Background handled by Tailwind classes on body element */
            overflow: hidden;
        }
        
        /* BACKGROUND GRID SYSTEM */
        .grid-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            background-size: 50px 50px;
            background-image: 
                linear-gradient(to right, rgba(100, 116, 139, 0.1) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(100, 116, 139, 0.1) 1px, transparent 1px);
            mask-image: radial-gradient(circle at 50% 50%, black 40%, transparent 100%);
            pointer-events: none;
        }

        /* Utilities */
        .glass-panel {
            backdrop-filter: blur(16px);
        }
        
        .glow-input {
            transition: all 0.3s ease;
        }
        .glow-input:focus-within {
            box-shadow: 0 0 30px rgba(34, 211, 238, 0.15);
            border-color: rgba(34, 211, 238, 0.4);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 3px;
        }

        .loader {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(34, 211, 238, 0.3);
            border-radius: 50%;
            border-top-color: #22d3ee;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sidebar-item {
            transition: all 0.2s ease;
            position: relative;
        }
        .sidebar-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: #22d3ee;
            transform: scaleY(0);
            transition: transform 0.2s ease;
            border-radius: 0 4px 4px 0;
        }
        .sidebar-item.active {
            background: rgba(34, 211, 238, 0.1);
            color: #22d3ee;
        }
        .sidebar-item.active::before {
            transform: scaleY(1);
        }
        
        .mic-active {
            color: #ef4444;
            animation: pulse 1.5s infinite;
        }

        .thinking-mode {
            animation: thinkingPulse 2s infinite;
            border-color: #a855f7 !important;
        }

        /* Thinking Gradient Text */
        .thinking-text-gradient {
            background: linear-gradient(90deg, #a855f7, #ec4899, #a855f7);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: brainWave 2s linear infinite;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="font-sans antialiased text-slate-900 bg-space-50 dark:bg-space-950 dark:text-slate-300 selection:bg-cyan-500/30 selection:text-cyan-800 dark:selection:text-cyan-200 transition-colors duration-300">

    <!-- THE GRID -->
    <div class="grid-bg"></div>
    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-[0.03] pointer-events-none z-0"></div>

    <!-- APP CONTAINER -->
    <div id="app-root" class="relative z-10 flex h-screen w-full">
        
        <!-- SIDEBAR -->
        <aside class="w-64 border-r border-slate-200 dark:border-white/5 bg-white/80 dark:bg-space-950/80 backdrop-blur-md flex flex-col py-6 z-50 transition-colors duration-300">
            <!-- Brand -->
            <div class="px-6 mb-10 flex items-center gap-3 cursor-pointer group" onclick="resetSystem()">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white shadow-lg group-hover:scale-105 transition-transform">
                    <i class="fa-solid fa-cube text-sm"></i>
                </div>
                <div>
                    <h1 class="font-bold text-slate-900 dark:text-white tracking-tight leading-none">Venture-OS</h1>
                    <span class="text-[10px] font-mono text-slate-500 dark:text-slate-400">Startup Architect</span>
                </div>
            </div>
            
            <!-- Nav -->
            <nav class="flex-1 w-full flex flex-col gap-1 px-3">
                <div class="text-[10px] font-bold text-slate-400 dark:text-slate-600 uppercase tracking-widest px-3 mb-2 mt-2">Workstation</div>
                
                <button onclick="switchView('lobby')" id="nav-lobby" class="sidebar-item active w-full px-3 py-2.5 rounded-lg flex items-center gap-3 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white text-left">
                    <i class="fa-solid fa-rocket w-5 text-center"></i>
                    <span>Lobby</span>
                </button>

                <button onclick="switchView('files')" id="nav-files" class="sidebar-item w-full px-3 py-2.5 rounded-lg flex items-center gap-3 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white text-left">
                    <i class="fa-solid fa-folder-open w-5 text-center"></i>
                    <span>Cabinet</span>
                </button>
                
                <button onclick="switchView('strategist')" id="nav-strategist" class="sidebar-item w-full px-3 py-2.5 rounded-lg flex items-center gap-3 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white text-left">
                    <i class="fa-solid fa-chess-knight w-5 text-center"></i>
                    <span>Strategist</span>
                </button>

                <button onclick="switchView('roadmap')" id="nav-roadmap" class="sidebar-item w-full px-3 py-2.5 rounded-lg flex items-center gap-3 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white text-left">
                    <i class="fa-solid fa-map w-5 text-center"></i>
                    <span>Roadmap</span>
                </button>

                <button onclick="switchView('builder')" id="nav-builder" class="sidebar-item w-full px-3 py-2.5 rounded-lg flex items-center gap-3 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white text-left">
                    <i class="fa-solid fa-layer-group w-5 text-center"></i>
                    <span>App Builder</span>
                </button>

                <div class="text-[10px] font-bold text-slate-400 dark:text-slate-600 uppercase tracking-widest px-3 mb-2 mt-6">Tools</div>
                
                <button onclick="openImageModal()" class="w-full px-3 py-2.5 rounded-lg flex items-center gap-3 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white text-left transition-colors">
                    <i class="fa-solid fa-image w-5 text-center text-cyan-500"></i>
                    <span>Asset Gen</span>
                </button>

                <div class="text-[10px] font-bold text-slate-400 dark:text-slate-600 uppercase tracking-widest px-3 mb-2 mt-6">Settings</div>

                <div class="flex gap-2 px-3 mt-1">
                    <button onclick="setTheme('light')" class="flex-1 py-2 rounded-lg bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 text-xs font-medium text-slate-600 dark:text-slate-400 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-sun"></i> Light
                    </button>
                    <button onclick="setTheme('dark')" class="flex-1 py-2 rounded-lg bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 text-xs font-medium text-slate-600 dark:text-slate-400 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-moon"></i> Dark
                    </button>
                </div>
            </nav>

            <!-- User -->
            <div class="px-6 pt-6 border-t border-slate-200 dark:border-white/5 mt-auto">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-800 flex items-center justify-center text-xs font-mono font-bold text-slate-600 dark:text-slate-400">
                        JD
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-bold text-slate-900 dark:text-white truncate">John Doe</div>
                        <div class="text-[10px] text-slate-500 truncate">Pro License Active</div>
                    </div>
                    <i class="fa-solid fa-gear text-slate-400 hover:text-cyan-500 cursor-pointer transition-colors"></i>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 relative overflow-hidden flex flex-col bg-slate-50 dark:bg-space-950 transition-colors duration-300">
            
            <!-- VIEW 1: LOBBY (Landing Page) -->
            <section id="view-lobby" class="absolute inset-0 flex flex-col items-center justify-center p-6 transition-all duration-500 z-30">
                
                <div class="mb-10 px-4 py-1.5 rounded-full bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 flex items-center gap-2 backdrop-blur-sm shadow-sm">
                    <div class="w-2 h-2 rounded-full bg-cyan-500 animate-pulse"></div>
                    <span class="text-[10px] font-mono text-slate-600 dark:text-cyan-400 uppercase tracking-widest">Gemini System Online v4.2</span>
                </div>

                <h1 class="text-5xl md:text-7xl font-bold text-slate-900 dark:text-white mb-6 text-center tracking-tight animate-slide-up">
                    The Operating System<br>for Startups.
                </h1>

                <p class="text-lg md:text-xl text-slate-600 dark:text-slate-400 max-w-2xl mb-12 text-center animate-slide-up" style="animation-delay: 0.1s;">
                    Powered by <span class="text-slate-900 dark:text-white font-medium">Gemini 3 Pro</span>. Generate your <span class="text-slate-900 dark:text-white font-medium">Roadmap</span>, <span class="text-slate-900 dark:text-white font-medium">Business Strategy</span>, and <span class="text-slate-900 dark:text-white font-medium">Assets</span> in one synchronized workflow.
                </p>

                <!-- Input Module -->
                <div class="w-full max-w-2xl relative group animate-slide-up" style="animation-delay: 0.2s;">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-500"></div>
                    <div class="relative flex flex-col sm:flex-row items-center bg-white dark:bg-[#0a0a0f] rounded-2xl border border-slate-200 dark:border-white/10 p-2 shadow-xl glow-input">
                        
                        <div class="flex-1 flex items-center w-full relative">
                            <input type="text" id="idea-input" 
                                placeholder="Describe your startup idea..." 
                                class="flex-1 bg-transparent border-none text-slate-900 dark:text-white px-6 py-5 text-lg placeholder-slate-400 dark:placeholder-slate-600 focus:ring-0 outline-none font-medium w-full pr-12"
                                onkeydown="if(event.key === 'Enter') handleInitiate()">
                            
                            <!-- Mic Button -->
                            <button onclick="toggleRecording('idea-input')" id="mic-idea-input" class="absolute right-4 text-slate-400 hover:text-cyan-500 transition-colors p-2">
                                <i class="fa-solid fa-microphone"></i>
                            </button>
                        </div>
                        
                        <button id="btn-initiate" onclick="handleInitiate()" class="w-full sm:w-auto mt-2 sm:mt-0 bg-cyan-500 hover:bg-cyan-400 text-white dark:text-black font-bold px-8 py-4 rounded-xl flex items-center justify-center gap-3 transition-all hover:scale-[1.02] shadow-[0_0_20px_rgba(34,211,238,0.3)] whitespace-nowrap">
                            <span id="btn-text">INITIATE</span>
                            <div id="btn-loader" class="loader hidden border-white dark:border-black border-t-transparent"></div>
                        </button>
                    </div>
                </div>

                <!-- Recent Sessions -->
                <div class="mt-24 w-full max-w-2xl animate-slide-up" style="animation-delay: 0.3s;">
                    <div class="flex justify-between items-center mb-4 px-1">
                        <div class="text-[10px] font-mono text-slate-400 dark:text-slate-500 uppercase tracking-widest">Recent Architectures</div>
                        <button onclick="switchView('files')" class="text-[10px] text-cyan-600 dark:text-cyan-400 hover:underline">View All</button>
                    </div>
                    <div id="lobby-history-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Dynamic History Items -->
                        <div class="p-4 text-center text-slate-400 dark:text-slate-600 text-xs italic">
                            No recent projects found.
                        </div>
                    </div>
                </div>
            </section>

             <!-- VIEW 2: CABINET (File Storage) -->
             <section id="view-files" class="absolute inset-0 hidden flex flex-col bg-slate-50 dark:bg-space-950 animate-fade-in z-20">
                <header class="h-16 border-b border-slate-200 dark:border-white/5 bg-white/80 dark:bg-space-950/80 backdrop-blur flex items-center justify-between px-8 z-20 sticky top-0">
                    <div>
                        <h2 class="text-lg font-bold text-slate-900 dark:text-white tracking-tight">Project Cabinet</h2>
                        <div class="flex items-center gap-2 text-[10px] font-mono text-slate-500 dark:text-slate-400 uppercase">
                            <i class="fa-solid fa-database"></i> Local Storage
                        </div>
                    </div>
                </header>
                
                <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                    <div id="files-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Files Injected Here -->
                    </div>
                </div>
            </section>

            <!-- VIEW 3: STRATEGIST (Document) -->
            <section id="view-strategist" class="absolute inset-0 hidden flex flex-col bg-slate-50 dark:bg-space-950 animate-fade-in z-20 pb-24">
                <!-- Header -->
                <header class="h-16 border-b border-slate-200 dark:border-white/5 bg-white/80 dark:bg-space-950/80 backdrop-blur flex items-center justify-between px-8 z-20 sticky top-0">
                    <div>
                        <h2 id="project-name" class="text-lg font-bold text-slate-900 dark:text-white tracking-tight">Project Alpha</h2>
                        <div class="flex items-center gap-2 text-[10px] font-mono text-cyan-600 dark:text-cyan-500 uppercase">
                            <span class="w-1 h-1 rounded-full bg-cyan-500"></span> Strategy Module
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="handleExport('contracts')" class="px-3 py-1.5 text-xs text-slate-500 hover:text-slate-900 dark:text-slate-400 dark:hover:text-white border border-slate-200 dark:border-white/10 rounded hover:bg-slate-100 dark:hover:bg-white/5 transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-file-contract"></i> Generate Contracts
                        </button>
                        <button onclick="handleExport('pdf')" class="px-3 py-1.5 text-xs text-slate-500 hover:text-slate-900 dark:text-slate-400 dark:hover:text-white border border-slate-200 dark:border-white/10 rounded hover:bg-slate-100 dark:hover:bg-white/5 transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-download"></i> Export PDF
                        </button>
                    </div>
                </header>

                <!-- Doc Canvas -->
                <div class="flex-1 overflow-y-auto p-8 flex justify-center custom-scrollbar relative">
                    <div class="w-full max-w-3xl bg-white dark:bg-[#0e0e12] border border-slate-200 dark:border-white/10 min-h-[800px] shadow-xl relative p-12 mb-20 rounded-lg">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 via-purple-500 to-blue-500 opacity-70"></div>
                        
                        <div class="font-serif text-slate-700 dark:text-slate-300 leading-relaxed space-y-6">
                            <div class="border-b border-slate-100 dark:border-white/5 pb-6 mb-8">
                                <h1 class="text-3xl font-sans font-bold text-slate-900 dark:text-white mb-2">Executive Summary</h1>
                                <p class="text-xs font-sans text-slate-400 dark:text-slate-500 uppercase tracking-widest">Confidential â€¢ Generated via Venture-OS</p>
                            </div>
                            
                            <div id="doc-content">
                                <p class="text-slate-400 dark:text-slate-600 italic">Waiting for architecture generation...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW 4: ROADMAP (New) -->
            <section id="view-roadmap" class="absolute inset-0 hidden flex flex-col bg-slate-50 dark:bg-space-950 animate-fade-in z-20">
                <header class="h-16 border-b border-slate-200 dark:border-white/5 bg-white/80 dark:bg-space-950/80 backdrop-blur flex items-center justify-between px-8 z-20 sticky top-0">
                    <div>
                        <h2 class="text-lg font-bold text-slate-900 dark:text-white tracking-tight">Execution Roadmap</h2>
                        <div class="flex items-center gap-2 text-[10px] font-mono text-purple-600 dark:text-purple-500 uppercase">
                            <span class="w-1 h-1 rounded-full bg-purple-500"></span> Inception to Revenue
                        </div>
                    </div>
                </header>
                
                <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                    <div class="max-w-4xl mx-auto" id="roadmap-container">
                        <!-- Roadmap items injected here -->
                        <div class="flex flex-col items-center justify-center h-64 text-slate-400 dark:text-slate-600">
                             <i class="fa-solid fa-map-location-dot text-4xl mb-4 opacity-50"></i>
                             <p>No roadmap generated yet. Start a project in the Lobby.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW 5: BUILDER (Preview) -->
            <section id="view-builder" class="absolute inset-0 hidden flex bg-slate-50 dark:bg-space-950 animate-fade-in z-20 pb-24">
                <div class="flex-1 flex flex-row h-full justify-between">
                    
                    <!-- Left Control Panel (App Config) -->
                    <div class="flex-1 p-10 flex flex-col overflow-y-auto">
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-6">App Configuration</h2>
                        <div class="space-y-6">
                            <div class="p-6 bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl">
                                <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4">Core Settings</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs text-slate-500 mb-1">App Name</label>
                                        <input type="text" id="config-app-name" class="w-full bg-slate-100 dark:bg-black/50 border border-slate-200 dark:border-white/10 rounded p-2 text-sm text-slate-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-500 mb-1">Primary Color</label>
                                        <div class="flex gap-2">
                                            <input type="color" id="config-color" class="w-8 h-8 rounded cursor-pointer bg-transparent" onchange="updatePreviewColor(this.value)">
                                            <input type="text" id="config-color-text" class="flex-1 bg-slate-100 dark:bg-black/50 border border-slate-200 dark:border-white/10 rounded p-2 text-sm text-slate-900 dark:text-white font-mono">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                             <div class="p-6 bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl">
                                <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4">Assets</h3>
                                <button onclick="openImageModal()" class="w-full py-3 border border-dashed border-slate-300 dark:border-white/20 rounded-lg text-slate-500 hover:text-cyan-500 hover:border-cyan-500 transition-colors flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-plus"></i> Generate New Asset
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right Phone Preview (Far Right) -->
                    <div class="w-[450px] bg-slate-200 dark:bg-black/20 border-l border-slate-300 dark:border-white/5 flex items-center justify-center relative flex-shrink-0">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/graphy.png')] opacity-5 pointer-events-none"></div>
                        
                        <!-- Mobile Frame -->
                        <div class="w-[320px] h-[640px] bg-black rounded-[3rem] border-4 border-slate-800 shadow-2xl relative overflow-hidden ring-1 ring-white/10 transition-transform duration-500 hover:scale-[1.01]">
                            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-24 h-6 bg-slate-800 rounded-b-xl z-20"></div>
                            
                            <!-- Screen -->
                            <div class="w-full h-full bg-white flex flex-col relative">
                                <div class="h-32 bg-cyan-600 p-6 flex items-end transition-colors duration-500" id="preview-header">
                                    <h2 id="builder-project-name" class="text-white font-bold text-xl">App Name</h2>
                                </div>
                                <div class="p-4 space-y-4 relative z-10">
                                    <div class="h-40 bg-slate-100 rounded-xl flex items-center justify-center text-slate-300 overflow-hidden relative group">
                                        <!-- Asset Placeholder or Generated Image -->
                                        <img id="builder-asset-img" src="" class="hidden w-full h-full object-cover" />
                                        <div id="builder-asset-placeholder">
                                            <i class="fa-solid fa-image text-2xl"></i>
                                        </div>
                                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity cursor-pointer" onclick="openImageModal()">
                                            <span class="text-white text-xs font-bold">CHANGE ASSET</span>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="h-2 w-2/3 bg-slate-100 rounded"></div>
                                        <div class="h-2 w-1/2 bg-slate-100 rounded"></div>
                                        <div class="h-2 w-3/4 bg-slate-100 rounded"></div>
                                    </div>
                                    <div id="preview-button" class="h-12 w-full bg-cyan-500 rounded-lg mt-8 flex items-center justify-center text-white font-bold shadow-md transition-colors duration-500 hover:opacity-90 cursor-pointer">
                                        Get Started
                                    </div>
                                </div>
                                <!-- Bottom Nav Mock -->
                                <div class="mt-auto h-16 border-t border-slate-100 flex justify-around items-center text-slate-300">
                                    <i class="fa-solid fa-house text-slate-800"></i>
                                    <i class="fa-solid fa-compass"></i>
                                    <i class="fa-solid fa-user"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- GLOBAL AI COMMAND BAR (Jarvis) -->
            <div id="global-command-bar" class="absolute bottom-8 left-1/2 -translate-x-1/2 w-full max-w-xl z-50 px-4 transition-all duration-500 translate-y-20 opacity-0">
                
                <!-- Thinking Visualizer -->
                <div id="thinking-visualizer" class="hidden mb-4 p-4 rounded-xl bg-black/80 backdrop-blur border border-purple-500/30 flex items-center gap-4 animate-slide-up">
                    <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center">
                        <i class="fa-solid fa-brain text-purple-400 animate-pulse"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-xs font-bold text-purple-400 mb-1 thinking-text-gradient">AI THINKING ACTIVE</div>
                        <div class="h-1 w-full bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full bg-purple-500 w-1/3 animate-brain-wave"></div>
                        </div>
                    </div>
                </div>

                <!-- System Status Output -->
                <div id="system-status" class="mb-2 text-center opacity-0 transition-opacity duration-300">
                    <span class="inline-block bg-white dark:bg-black/80 text-cyan-600 dark:text-cyan-400 text-[10px] font-mono px-3 py-1 rounded-full border border-cyan-500/20 shadow-sm">
                        <i class="fa-solid fa-circle-check mr-1"></i> Changes Applied
                    </span>
                </div>
                
                <!-- Search Sources Display -->
                <div id="search-sources" class="mb-2 flex gap-2 overflow-x-auto pb-1 opacity-0 transition-opacity duration-300 custom-scrollbar">
                    <!-- Source items injected here -->
                </div>

                <div id="command-container" class="glass-panel rounded-2xl p-1.5 flex flex-col gap-0 shadow-2xl ring-1 ring-slate-200 dark:ring-white/10 bg-white/90 dark:bg-[#0a0a0f]/90 relative transition-all duration-300">
                    <div class="flex items-center gap-2">
                        <div id="ai-icon" class="w-8 h-8 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center flex-shrink-0">
                            <i class="fa-solid fa-sparkles text-white text-xs"></i>
                        </div>
                        <input type="text" id="global-chat-input" 
                            placeholder="Ask Venture-OS to update..." 
                            class="flex-1 bg-transparent border-none text-slate-900 dark:text-white text-sm focus:ring-0 outline-none placeholder-slate-400 dark:placeholder-slate-500 font-medium h-10 px-2"
                            onkeydown="if(event.key === 'Enter') handleGlobalChat()">
                        
                        <!-- Actions -->
                        <div class="flex items-center gap-1">
                            <button onclick="toggleRecording('global-chat-input')" id="mic-global-chat-input" class="text-slate-400 hover:text-cyan-500 transition-colors p-2 rounded-full hover:bg-slate-100 dark:hover:bg-white/5">
                                <i class="fa-solid fa-microphone"></i>
                            </button>
                            
                            <!-- Submit Button -->
                            <button onclick="handleGlobalChat()" class="ml-2 px-4 py-1.5 bg-cyan-500 hover:bg-cyan-400 text-white text-xs font-bold rounded-lg transition-colors flex items-center gap-2">
                                SUBMIT <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Feature Toggles -->
                    <div class="flex gap-4 px-2 py-1 border-t border-slate-200 dark:border-white/5 mt-1 justify-between">
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <input type="checkbox" id="use-search" class="w-3 h-3 rounded border-slate-300 dark:border-slate-600 bg-transparent text-cyan-500 focus:ring-0">
                                <span class="text-[10px] text-slate-500 group-hover:text-cyan-500 transition-colors">Google Search</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <input type="checkbox" id="use-thinking" class="w-3 h-3 rounded border-slate-300 dark:border-slate-600 bg-transparent text-purple-500 focus:ring-0">
                                <span class="text-[10px] text-slate-500 group-hover:text-purple-400 transition-colors">Deep Thinking</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL: IMAGE GENERATION -->
    <div id="modal-image" class="fixed inset-0 z-[100] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/50 dark:bg-black/90 backdrop-blur-md" onclick="closeImageModal()"></div>
        <div class="relative w-full max-w-md bg-white dark:bg-[#0a0a0f] border border-slate-200 dark:border-white/10 rounded-2xl shadow-2xl p-6 flex flex-col animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <i class="fa-solid fa-image text-cyan-500"></i> Generate Asset
                </h2>
                <button onclick="closeImageModal()" class="text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-500 uppercase tracking-widest mb-2">Prompt</label>
                    <textarea id="img-prompt" rows="3" class="w-full bg-slate-50 dark:bg-black/50 border border-slate-200 dark:border-white/10 rounded-lg p-3 text-sm text-slate-900 dark:text-white focus:border-cyan-500 outline-none" placeholder="A futuristic robot holding a skateboard..."></textarea>
                </div>
                
                <div>
                    <label class="block text-xs text-slate-500 uppercase tracking-widest mb-2">Resolution</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="selectSize('1K', this)" class="size-btn active px-3 py-2 rounded-lg border border-cyan-500/50 bg-cyan-50 dark:bg-cyan-500/10 text-cyan-600 dark:text-cyan-400 text-xs font-mono text-center transition-all">1K</button>
                        <button onclick="selectSize('2K', this)" class="size-btn px-3 py-2 rounded-lg border border-slate-200 dark:border-white/10 bg-white dark:bg-black text-slate-500 text-xs font-mono text-center hover:bg-slate-50 dark:hover:bg-white/5 transition-all">2K</button>
                        <button onclick="selectSize('4K', this)" class="size-btn px-3 py-2 rounded-lg border border-slate-200 dark:border-white/10 bg-white dark:bg-black text-slate-500 text-xs font-mono text-center hover:bg-slate-50 dark:hover:bg-white/5 transition-all">4K</button>
                    </div>
                </div>

                <button onclick="generateAsset()" id="btn-gen-img" class="w-full py-3 rounded-xl bg-gradient-to-r from-cyan-600 to-blue-600 text-white font-bold hover:shadow-[0_0_20px_rgba(34,211,238,0.3)] transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Generate
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: LICENSE GATE -->
    <div id="modal-license" class="fixed inset-0 z-[100] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/50 dark:bg-black/90 backdrop-blur-md" onclick="closeLicenseModal()"></div>
        <div class="relative w-full max-w-md bg-white dark:bg-[#0a0a0f] border border-slate-200 dark:border-white/10 rounded-2xl shadow-2xl p-8 flex flex-col items-center text-center animate-slide-up">
            <button onclick="closeLicenseModal()" class="absolute top-4 right-4 text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
            <div class="w-16 h-16 rounded-full bg-gold-500/10 border border-gold-500/40 flex items-center justify-center text-gold-500 mb-6 shadow-[0_0_30px_rgba(245,158,11,0.2)]">
                <i class="fa-solid fa-lock text-xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">Unlock Exports</h2>
            <p class="text-slate-500 dark:text-slate-400 text-sm mb-8 leading-relaxed">
                Your architecture is ready. Purchase a pass to save, export code, and download your business plan.
            </p>
            <a href="#" class="w-full mb-6 group">
                <button class="w-full py-3.5 rounded-xl bg-gradient-to-r from-gold-500 to-yellow-600 text-black font-bold hover:shadow-[0_0_20px_rgba(245,158,11,0.4)] transition-all transform group-hover:scale-[1.02]">
                    Purchase License
                </button>
            </a>
            <div class="w-full flex items-center gap-4 mb-6">
                <div class="h-[1px] flex-1 bg-slate-200 dark:bg-white/10"></div>
                <span class="text-[10px] text-slate-500 dark:text-slate-600 uppercase tracking-widest font-mono">Or Enter Key</span>
                <div class="h-[1px] flex-1 bg-slate-200 dark:bg-white/10"></div>
            </div>
            <div class="w-full relative">
                <input type="text" id="license-key" placeholder="XXXX-XXXX" 
                    class="w-full bg-slate-100 dark:bg-black border border-slate-200 dark:border-white/10 rounded-xl pl-4 pr-12 py-3 text-sm text-slate-900 dark:text-white focus:border-cyan-500 outline-none uppercase font-mono placeholder-slate-400 dark:placeholder-slate-700 transition-colors">
                <button onclick="validateKey()" class="absolute right-2 top-2 bottom-2 aspect-square bg-white dark:bg-white/10 hover:bg-cyan-500 hover:text-black rounded-lg text-slate-500 dark:text-white transition-colors flex items-center justify-center">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
            <p id="key-error" class="text-red-500 text-xs mt-3 hidden font-mono">Access Denied. Invalid Key.</p>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { GoogleGenAI, Type } from "@google/genai";

        // Initialize Gemini securely
        // SAFEGUARD: Check if process is defined (for browser/GitHub/Vercel compatibility)
        // If hosting statically, process.env is usually not available in the browser.
        // You can paste your API key below in MANUAL_API_KEY if needed.
        const MANUAL_API_KEY = ""; 

        const getApiKey = () => {
            if (MANUAL_API_KEY) return MANUAL_API_KEY;

            // 1. Check Vite/Vercel Environment Variables (Priority)
            try {
                if (import.meta.env && import.meta.env.VITE_GEMINI_API_KEY) {
                    return import.meta.env.VITE_GEMINI_API_KEY;
                }
            } catch (e) {
                // import.meta might not be available in all contexts
            }

            // 2. Check Process Environment Variables (Legacy/Local)
            try {
                if (typeof process !== "undefined" && process.env && process.env.API_KEY) {
                    return process.env.API_KEY;
                }
            } catch (e) {
                console.warn("Environment variables not accessible. If you are running this on Vercel/GitHub Pages statically, you must manually configure the API key in the source code or use a local development environment.");
            }
            return ""; 
        };
        
        const apiKey = getApiKey();
        // Only init AI if key is present to prevent immediate crash
        const ai = apiKey ? new GoogleGenAI({ apiKey }) : null;

        // --- GLOBAL STATE ---
        let currentView = 'lobby';
        let mediaRecorder = null;
        let audioChunks = [];
        let selectedImageSize = '1K';
        let isDarkMode = true;
        let pendingExportType = null;
        
        // Expose functions to window
        window.switchView = switchView;
        window.handleInitiate = handleInitiate;
        window.handleGlobalChat = handleGlobalChat;
        window.toggleRecording = toggleRecording;
        window.openImageModal = openImageModal;
        window.closeImageModal = closeImageModal;
        window.selectSize = selectSize;
        window.generateAsset = generateAsset;
        window.handleExport = handleExport;
        window.closeLicenseModal = closeLicenseModal;
        window.validateKey = validateKey;
        window.resetSystem = resetSystem;
        window.setTheme = setTheme;
        window.updatePreviewColor = updatePreviewColor;
        window.loadProject = loadProject;
        window.deleteProject = deleteProject;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const data = localStorage.getItem('venture_data');
            if (data) {
                // If there's data in the legacy/active key, check if we need to load it visually
                // But generally, we start at Lobby now unless specifically checking for active session
            }
            // Check theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                setTheme(savedTheme, false);
            }
            renderHistory();
        });

        function setTheme(mode, save = true) {
            const html = document.documentElement;
            if (mode === 'light') {
                html.classList.remove('dark');
                isDarkMode = false;
                if(save) localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                isDarkMode = true;
                if(save) localStorage.setItem('theme', 'dark');
            }
        }

        // --- HISTORY & STORAGE MANAGER ---

        function saveProjectToHistory(data) {
            const history = JSON.parse(localStorage.getItem('venture_history') || '[]');
            const newProject = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                data: data
            };
            // Add to beginning
            history.unshift(newProject);
            localStorage.setItem('venture_history', JSON.stringify(history));
            renderHistory();
        }

        function loadProject(id) {
            const history = JSON.parse(localStorage.getItem('venture_history') || '[]');
            const project = history.find(p => p.id === parseInt(id));
            if(project) {
                localStorage.setItem('venture_data', JSON.stringify(project.data));
                unlockDashboard();
            }
        }

        function deleteProject(id, event) {
            if(event) event.stopPropagation();
            if(!confirm("Delete this project permanently?")) return;
            
            let history = JSON.parse(localStorage.getItem('venture_history') || '[]');
            history = history.filter(p => p.id !== parseInt(id));
            localStorage.setItem('venture_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('venture_history') || '[]');
            const lobbyContainer = document.getElementById('lobby-history-container');
            const filesGrid = document.getElementById('files-grid');

            // Render Lobby (Max 2 recent)
            if (history.length === 0) {
                lobbyContainer.innerHTML = `<div class="p-4 col-span-2 text-center text-slate-400 dark:text-slate-600 text-xs italic">No recent projects found.</div>`;
            } else {
                lobbyContainer.innerHTML = history.slice(0, 2).map(p => `
                    <div onclick="loadProject('${p.id}')" class="glass-panel bg-white/50 dark:bg-white/5 border border-slate-200 dark:border-white/10 p-4 rounded-xl flex items-center justify-between hover:bg-white dark:hover:bg-white/10 cursor-pointer transition-colors group shadow-sm">
                        <div>
                            <div class="text-slate-800 dark:text-slate-200 font-medium text-sm group-hover:text-cyan-600 dark:group-hover:text-cyan-400 transition-colors">${p.data.project_name || 'Untitled Project'}</div>
                            <div class="text-[10px] text-slate-500 dark:text-slate-600 mt-1">${new Date(p.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="w-1.5 h-1.5 rounded-full bg-cyan-500"></div>
                    </div>
                `).join('');
            }

            // Render Cabinet (All)
            if (history.length === 0) {
                filesGrid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center p-12 text-slate-400 dark:text-slate-600">
                        <i class="fa-solid fa-folder-open text-4xl mb-4 opacity-50"></i>
                        <p>Your cabinet is empty.</p>
                    </div>
                `;
            } else {
                filesGrid.innerHTML = history.map(p => `
                    <div onclick="loadProject('${p.id}')" class="group relative bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl p-5 hover:border-cyan-500/50 hover:shadow-lg hover:shadow-cyan-500/10 transition-all cursor-pointer flex flex-col h-48">
                        <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="deleteProject('${p.id}', event)" class="text-slate-400 hover:text-red-500 transition-colors p-1">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-slate-100 to-slate-200 dark:from-white/5 dark:to-white/10 flex items-center justify-center text-slate-500 dark:text-slate-400 mb-4 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-cube"></i>
                        </div>
                        <h3 class="font-bold text-slate-900 dark:text-white truncate mb-1 pr-6">${p.data.project_name || 'Untitled'}</h3>
                        <p class="text-xs text-slate-500 dark:text-slate-400 line-clamp-2 mb-auto">${p.data.tagline || 'No description available.'}</p>
                        
                        <div class="pt-4 border-t border-slate-100 dark:border-white/5 flex items-center justify-between mt-4">
                            <span class="text-[10px] font-mono text-slate-400">${new Date(p.timestamp).toLocaleDateString()}</span>
                            <span class="text-[10px] text-cyan-600 dark:text-cyan-400 font-bold opacity-0 group-hover:opacity-100 transition-opacity">OPEN <i class="fa-solid fa-arrow-right ml-1"></i></span>
                        </div>
                    </div>
                `).join('');
            }
        }

        // --- 1. CORE ARCHITECTURE GENERATION (Gemini 3 Pro + Thinking) ---
        async function handleInitiate() {
            const input = document.getElementById('idea-input').value;
            if(!input) return;
            
            // Check for API Key validity
            if (!apiKey || apiKey === "") {
                alert("API Key is missing. Since you are hosting this statically on Vercel, the app cannot access environment variables. Please edit the index.html file and paste your API Key into the 'MANUAL_API_KEY' constant near the bottom of the script.");
                return;
            }

            const btn = document.getElementById('btn-initiate');
            const txt = document.getElementById('btn-text');
            const loader = document.getElementById('btn-loader');
            
            btn.disabled = true;
            txt.innerText = "THINKING...";
            loader.classList.remove('hidden');

            try {
                // Extended Schema for Roadmap and Pricing
                const schema = {
                    type: Type.OBJECT,
                    properties: {
                        project_name: { type: Type.STRING },
                        business_plan: { type: Type.STRING, description: "Markdown formatted detailed business plan including executive summary, market analysis, and revenue model." },
                        tagline: { type: Type.STRING },
                        primary_color: { type: Type.STRING, description: "Hex code" },
                        pricing_plan: {
                            type: Type.ARRAY,
                            items: {
                                type: Type.OBJECT,
                                properties: {
                                    name: { type: Type.STRING, description: "Tier name e.g. Hustler" },
                                    price: { type: Type.STRING, description: "Price in ZAR e.g. R499" },
                                    features: { type: Type.ARRAY, items: { type: Type.STRING } }
                                }
                            }
                        },
                        roadmap: {
                            type: Type.ARRAY,
                            items: {
                                type: Type.OBJECT,
                                properties: {
                                    phase: { type: Type.STRING, description: "e.g., Inception, MVP, Growth, Revenue" },
                                    timeline: { type: Type.STRING, description: "e.g., Month 1-2" },
                                    tasks: { type: Type.ARRAY, items: { type: Type.STRING } }
                                }
                            }
                        }
                    },
                    required: ["project_name", "business_plan", "tagline", "primary_color", "pricing_plan", "roadmap"]
                };

                const systemPrompt = `You are Venture-OS, a world-class startup architect for the South African market. Analyze this idea and generate a complete architecture with a detailed roadmap and pricing strategy: "${input}". 
                    Create a sophisticated, realistic business plan, a 3-tier pricing strategy, and technical identity. The roadmap must be complete and comprehensive.
                    
                    For the Pricing Plan:
                    - Create a Deserving Subscription Fee model tailored for South Africa (ZAR).
                    - Ensure the prices are Reasonable (e.g., R199 for Starter, R499 for Pro, R1499 for Enterprise).
                    - Use 'R' symbol for pricing.
                    - Tier 1: Hustler (Entry level).
                    - Tier 2: Founder (Growth level - Recommended).
                    - Tier 3: Empire (Scale level).
                    `;

                let response;
                let data;

                // ATTEMPT 1: Try Gemini 3 Pro (Thinking Model)
                try {
                    console.log("Attempting generation with gemini-3-pro-preview...");
                    response = await ai.models.generateContent({
                        model: 'gemini-3-pro-preview',
                        contents: systemPrompt,
                        config: {
                            responseMimeType: "application/json",
                            responseSchema: schema,
                            thinkingConfig: { thinkingBudget: 16000 }
                        }
                    });
                    data = JSON.parse(response.text);
                } catch (proError) {
                    console.warn("Gemini 3 Pro failed. Fallback to Flash initiated.", proError);
                    
                    // ATTEMPT 2: Fallback to Gemini 2.5 Flash (Faster, no thinking)
                    try {
                        txt.innerText = "RETRYING...";
                         response = await ai.models.generateContent({
                            model: 'gemini-2.5-flash',
                            contents: systemPrompt,
                            config: {
                                responseMimeType: "application/json",
                                responseSchema: schema
                            }
                        });
                        data = JSON.parse(response.text);
                    } catch (flashError) {
                        // If both fail, throw the original error to alert user
                         throw new Error(`Model Generation Failed. Pro Error: ${proError.message}. Flash Error: ${flashError.message}`);
                    }
                }
                
                // Initialize arrays if missing to prevent map errors
                if (!data.pricing_plan) data.pricing_plan = [];
                if (!data.roadmap) data.roadmap = [];

                // SAVE TO HISTORY
                saveProjectToHistory(data);
                
                // Set active data
                localStorage.setItem('venture_data', JSON.stringify(data));
                unlockDashboard();

            } catch (error) {
                console.error("Gemini Critical Error:", error);
                alert(`Architecture generation failed.\n\nReason: ${error.message}\n\nTip: Check if your API Key has access to 'gemini-3-pro-preview' or 'gemini-2.5-flash' in Google AI Studio.`);
            } finally {
                btn.disabled = false;
                txt.innerText = "INITIATE";
                loader.classList.add('hidden');
            }
        }

        function unlockDashboard() {
            try {
                const data = JSON.parse(localStorage.getItem('venture_data') || '{}');
                const docContent = document.getElementById('doc-content');

                // Set Project Name & Styles
                if(data.project_name) {
                    document.getElementById('project-name').innerText = data.project_name;
                    document.getElementById('builder-project-name').innerText = data.project_name;
                    document.getElementById('config-app-name').value = data.project_name;
                }
                if (data.primary_color) {
                     updatePreviewColor(data.primary_color);
                     document.getElementById('config-color').value = data.primary_color;
                     document.getElementById('config-color-text').value = data.primary_color;
                }

                // Set Business Plan
                if(data.business_plan) {
                    const formatted = data.business_plan
                        .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold text-slate-900 dark:text-white mt-6 mb-4">$1</h1>')
                        .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold text-slate-800 dark:text-white mt-5 mb-3">$1</h2>')
                        .replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 mt-4 mb-2">$1</h3>')
                        .replace(/\*\*(.*)\*\*/gim, '<b class="text-slate-900 dark:text-slate-200">$1</b>')
                        .replace(/\n/gim, '<br>');
                    
                    docContent.innerHTML = formatted;
                }
                
                // Fallback for existing projects that lack pricing data (Ensures UI always shows)
                // Using South African ZAR defaults
                const pricing = (data.pricing_plan && data.pricing_plan.length > 0) ? data.pricing_plan : [
                    { name: "Hustler", price: "R199", features: ["Basic Business Plan", "1 User", "Email Support"] },
                    { name: "Founder", price: "R499", features: ["Complete Architecture", "5 Users", "Priority Support", "Export to PDF"] },
                    { name: "Empire", price: "R1,499", features: ["White Label", "Unlimited Users", "24/7 Concierge", "API Access"] }
                ];

                // Render Pricing Plan (South African Context)
                const priceContainerHtml = `
                    <div class="mt-12 border-t border-slate-200 dark:border-white/10 pt-8">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-8 h-8 rounded-lg bg-green-500/10 flex items-center justify-center text-green-500">
                                <i class="fa-solid fa-money-bill-wave"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Subscription Strategy (ZAR)</h3>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Monthly Pricing Model</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            ${pricing.map((plan, i) => `
                                <div class="relative bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl p-6 flex flex-col hover:border-cyan-500/50 hover:shadow-lg transition-all group ${i === 1 ? 'ring-2 ring-cyan-500 shadow-cyan-500/10 z-10 scale-105' : 'opacity-90 hover:opacity-100'}">
                                    ${i === 1 ? '<div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-cyan-500 text-white text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wide shadow-md">Recommended</div>' : ''}
                                    <div class="mb-4">
                                        <h4 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1">${plan.name}</h4>
                                        <div class="text-3xl font-bold text-slate-900 dark:text-white flex items-baseline gap-1">
                                            ${plan.price} <span class="text-sm font-normal text-slate-500">/mo</span>
                                        </div>
                                    </div>
                                    <div class="h-px bg-slate-100 dark:bg-white/10 w-full mb-4"></div>
                                    <ul class="space-y-3 mb-8 flex-1">
                                        ${(plan.features || []).map(f => `
                                            <li class="flex gap-3 text-xs text-slate-600 dark:text-slate-300">
                                                <i class="fa-solid fa-check text-cyan-500 mt-0.5"></i> <span class="leading-relaxed">${f}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                    <button class="w-full py-2.5 rounded-lg bg-slate-100 dark:bg-white/10 hover:bg-cyan-500 hover:text-white text-slate-900 dark:text-white text-xs font-bold transition-colors uppercase tracking-wide">
                                        Choose ${plan.name}
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                docContent.insertAdjacentHTML('beforeend', priceContainerHtml);

                // Render Roadmap
                if (data.roadmap) {
                    const container = document.getElementById('roadmap-container');
                    container.innerHTML = '';
                    
                    data.roadmap.forEach((phase, index) => {
                        const html = `
                            <div class="relative pl-8 pb-12 border-l border-slate-200 dark:border-white/10 last:border-0">
                                <div class="absolute -left-[13px] top-0 w-6 h-6 rounded-full bg-slate-100 dark:bg-space-900 border-2 border-cyan-500 flex items-center justify-center text-[10px] font-bold text-cyan-500">
                                    ${index + 1}
                                </div>
                                <div class="bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl p-6 shadow-sm">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">${phase.phase}</h3>
                                            <span class="text-xs text-cyan-600 dark:text-cyan-400 font-mono uppercase">${phase.timeline}</span>
                                        </div>
                                        <div class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-white/5 flex items-center justify-center text-slate-400">
                                            <i class="fa-solid fa-check"></i>
                                        </div>
                                    </div>
                                    <ul class="space-y-2">
                                        ${(phase.tasks || []).map(task => `
                                            <li class="flex gap-3 text-sm text-slate-600 dark:text-slate-300">
                                                <span class="mt-1.5 w-1.5 h-1.5 rounded-full bg-slate-300 dark:bg-slate-600 flex-shrink-0"></span>
                                                ${task}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', html);
                    });
                }
                
                switchView('strategist');
            } catch (e) {
                console.error("Dashboard Unlock Error:", e);
                alert("Failed to render dashboard layout.");
            }
        }

        function updatePreviewColor(color) {
            document.getElementById('preview-header').style.backgroundColor = color;
            document.getElementById('preview-button').style.backgroundColor = color;
            // Also update text icon in generator
            const assetIcon = document.querySelector('#builder-asset-placeholder i');
            if(assetIcon) assetIcon.style.color = color;
        }

        // --- 2. GLOBAL CHAT & SEARCH (Flash/Pro + Tools) ---
        async function handleGlobalChat() {
            const inputEl = document.getElementById('global-chat-input');
            const aiIcon = document.getElementById('ai-icon');
            const status = document.getElementById('system-status');
            const sourcesDiv = document.getElementById('search-sources');
            const container = document.getElementById('command-container');
            const visualizer = document.getElementById('thinking-visualizer');
            
            const cmd = inputEl.value;
            const useSearch = document.getElementById('use-search').checked;
            const useThinking = document.getElementById('use-thinking').checked;

            if (!cmd) return;

            // UI Loading State
            inputEl.disabled = true;
            status.classList.add('opacity-0');
            sourcesDiv.innerHTML = '';
            sourcesDiv.classList.add('opacity-0');
            
            if (useThinking) {
                container.classList.add('thinking-mode');
                visualizer.classList.remove('hidden');
                aiIcon.querySelector('i').className = "fa-solid fa-brain text-white animate-pulse";
                aiIcon.classList.remove('from-cyan-500', 'to-blue-600');
                aiIcon.classList.add('from-purple-500', 'to-pink-600');
            } else {
                aiIcon.querySelector('i').className = "fa-solid fa-circle-notch fa-spin text-white";
            }

            try {
                // Determine context
                let context = 'business plan';
                if (currentView === 'builder') context = 'mobile app UI';
                if (currentView === 'roadmap') context = 'execution roadmap';
                
                const projectData = JSON.parse(localStorage.getItem('venture_data') || '{}');
                let currentContent = "";
                if (context === 'business plan') currentContent = projectData.business_plan;
                else if (context === 'roadmap') currentContent = JSON.stringify(projectData.roadmap);
                else currentContent = "App Config";

                let model = 'gemini-3-pro-preview';
                let config = {};
                let systemInstruction = `You are Venture-OS AI. You are assisting with the ${context} for the project "${projectData.project_name}".`;

                // Logic Selection
                if (useSearch) {
                    model = 'gemini-2.5-flash'; // Flash for Search
                    config = { tools: [{googleSearch: {}}] };
                    systemInstruction += " Use Google Search to find accurate, up-to-date information.";
                } else if (useThinking) {
                    model = 'gemini-3-pro-preview';
                    config = { thinkingConfig: { thinkingBudget: 32768 } };
                }

                // Append context to prompt
                const prompt = `${cmd}\n\nCurrent Context (${context}):\n${String(currentContent).substring(0, 1500)}...`;

                const response = await ai.models.generateContent({
                    model: model,
                    contents: prompt,
                    config: {
                        systemInstruction: systemInstruction,
                        ...config
                    }
                });

                // Handle Search Grounding
                if (response.candidates?.[0]?.groundingMetadata?.groundingChunks) {
                    sourcesDiv.innerHTML = '';
                    response.candidates[0].groundingMetadata.groundingChunks.forEach(chunk => {
                        if (chunk.web?.uri) {
                            const link = document.createElement('a');
                            link.href = chunk.web.uri;
                            link.target = '_blank';
                            link.className = "inline-flex items-center gap-1 px-2 py-1 bg-white/20 dark:bg-white/10 rounded text-[10px] text-cyan-600 dark:text-cyan-400 hover:bg-white/30 whitespace-nowrap";
                            link.innerHTML = `<i class="fa-solid fa-link"></i> ${chunk.web.title || 'Source'}`;
                            sourcesDiv.appendChild(link);
                        }
                    });
                    if (sourcesDiv.children.length > 0) sourcesDiv.classList.remove('opacity-0');
                }

                const responseText = response.text;

                // Update UI based on response
                if (currentView === 'strategist') {
                    const formatted = `<div class="mt-4 p-4 border-l-2 border-cyan-500 bg-cyan-50 dark:bg-cyan-900/10"><p class="text-xs text-cyan-600 dark:text-cyan-500 mb-1 font-bold">AI Update (${model}):</p><p class="text-sm text-slate-700 dark:text-slate-300">${responseText}</p></div>`;
                    document.getElementById('doc-content').insertAdjacentHTML('beforeend', formatted);
                    // Scroll to bottom
                    const scrollContainer = document.querySelector('#view-strategist .overflow-y-auto');
                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                } else {
                    alert(`AI Response: ${responseText}`);
                }

                status.innerHTML = `<span class="inline-block bg-white dark:bg-black/80 text-cyan-600 dark:text-cyan-400 text-[10px] font-mono px-3 py-1 rounded-full border border-cyan-500/20 shadow-sm"><i class="fa-solid fa-circle-check mr-1"></i> Processed with ${model}</span>`;
                status.classList.remove('opacity-0');

            } catch (e) {
                console.error("Chat Error:", e);
                alert("AI Error: " + e.message);
            } finally {
                container.classList.remove('thinking-mode');
                visualizer.classList.add('hidden');
                
                aiIcon.querySelector('i').className = "fa-solid fa-sparkles text-white text-xs";
                if (useThinking) {
                     aiIcon.classList.remove('from-purple-500', 'to-pink-600');
                     aiIcon.classList.add('from-cyan-500', 'to-blue-600');
                }
                
                inputEl.disabled = false;
                inputEl.value = '';
                inputEl.focus();
            }
        }

        // --- 3. AUDIO TRANSCRIPTION (Flash) ---
        async function toggleRecording(inputId) {
            const micBtn = document.getElementById(`mic-${inputId}`);
            const inputEl = document.getElementById(inputId);

            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                // START RECORDING
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        micBtn.classList.remove('mic-active');
                        inputEl.placeholder = "Transcribing...";
                        
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = async () => {
                            const base64Audio = reader.result.split(',')[1];
                            const mimeType = reader.result.split(',')[0].match(/:(.*?);/)[1];

                            try {
                                const response = await ai.models.generateContent({
                                    model: 'gemini-2.5-flash',
                                    contents: {
                                        parts: [
                                            { inlineData: { mimeType: mimeType, data: base64Audio } },
                                            { text: "Transcribe this audio exactly as spoken." }
                                        ]
                                    }
                                });
                                
                                inputEl.value = response.text;
                                inputEl.placeholder = "Describe...";
                            } catch (e) {
                                console.error("Transcription error:", e);
                                inputEl.placeholder = "Error transcribing audio.";
                            }
                        };
                    };

                    mediaRecorder.start();
                    micBtn.classList.add('mic-active');
                    inputEl.placeholder = "Listening...";

                } catch (err) {
                    console.error("Mic Error:", err);
                    alert("Microphone access denied.");
                }
            } else {
                mediaRecorder.stop();
            }
        }

        // --- 4. IMAGE GENERATION (Flash Image - No Config) ---
        function openImageModal() {
            document.getElementById('modal-image').classList.remove('hidden');
            document.getElementById('modal-image').classList.add('flex');
        }
        function closeImageModal() {
            document.getElementById('modal-image').classList.add('hidden');
        }
        function selectSize(size, btn) {
            selectedImageSize = size;
            document.querySelectorAll('.size-btn').forEach(b => {
                b.classList.remove('active', 'bg-cyan-50', 'dark:bg-cyan-500/10', 'text-cyan-600', 'dark:text-cyan-400', 'border-cyan-500/50');
                b.classList.add('bg-white', 'dark:bg-black', 'text-slate-500', 'border-slate-200', 'dark:border-white/10');
            });
            btn.classList.remove('bg-white', 'dark:bg-black', 'text-slate-500', 'border-slate-200', 'dark:border-white/10');
            btn.classList.add('active', 'bg-cyan-50', 'dark:bg-cyan-500/10', 'text-cyan-600', 'dark:text-cyan-400', 'border-cyan-500/50');
        }

        async function generateAsset() {
            const prompt = document.getElementById('img-prompt').value;
            if (!prompt) return;

            const btn = document.getElementById('btn-gen-img');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div> Generating...';

            try {
                // switched to gemini-2.5-flash-image to fix 403 error
                // also removed imageConfig as it is not supported by flash-image
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash-image',
                    contents: {
                        parts: [{ text: prompt + ` (${selectedImageSize} resolution style)` }]
                    }
                });

                let imageUrl = null;
                if (response.candidates && response.candidates[0].content && response.candidates[0].content.parts) {
                    for (const part of response.candidates[0].content.parts) {
                        if (part.inlineData) {
                            imageUrl = `data:image/png;base64,${part.inlineData.data}`;
                            break;
                        }
                    }
                }

                if (imageUrl) {
                    const imgEl = document.getElementById('builder-asset-img');
                    const placeholder = document.getElementById('builder-asset-placeholder');
                    
                    imgEl.src = imageUrl;
                    imgEl.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    
                    closeImageModal();
                    switchView('builder');
                } else {
                    alert("No image generated.");
                }

            } catch (e) {
                console.error("Image Gen Error:", e);
                alert("Failed to generate image.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- UTILS ---
        function switchView(viewId) {
            currentView = viewId;
            ['view-lobby', 'view-files', 'view-strategist', 'view-roadmap', 'view-builder'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            const target = document.getElementById('view-' + viewId);
            target.classList.remove('hidden');
            target.classList.add('flex');

            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + viewId).classList.add('active');

            const globalBar = document.getElementById('global-command-bar');
            if (viewId === 'lobby' || viewId === 'files') {
                globalBar.classList.remove('translate-y-0', 'opacity-100');
                globalBar.classList.add('translate-y-20', 'opacity-0');
            } else {
                globalBar.classList.remove('translate-y-20', 'opacity-0');
                globalBar.classList.add('translate-y-0', 'opacity-100');
                const input = document.getElementById('global-chat-input');
                if(viewId === 'strategist') input.placeholder = "Ask AI to expand the business plan...";
                if(viewId === 'roadmap') input.placeholder = "Ask AI to add a milestone...";
                if(viewId === 'builder') input.placeholder = "Ask AI to change app details...";
            }
        }

        function handleExport(type) {
            if (localStorage.getItem('venture_auth') === 'true') {
                 // Trigger real download
                 const data = JSON.parse(localStorage.getItem('venture_data') || '{}');
                 let content = "";
                 let filename = "venture-os-export.txt";

                 if(type === 'contracts') {
                    content = `
LEGAL CONTRACTS PACK
Generated by Venture-OS
Date: ${new Date().toLocaleDateString()}
Project: ${data.project_name || 'Untitled'}

==================================================
1. NON-DISCLOSURE AGREEMENT (NDA)
==================================================

This Non-Disclosure Agreement (the "Agreement") is entered into by and between ${data.project_name} ("Disclosing Party") and the Recipient.

1. Confidential Information
The Disclosing Party may disclose certain confidential and proprietary information...

[...Standard Boilerplate Content Truncated for Demo...]

==================================================
2. INDEPENDENT CONTRACTOR AGREEMENT
==================================================

This Agreement is made between ${data.project_name} and the Contractor...
                    `;
                    filename = "contracts_pack.txt";
                 } else {
                    content = `
${data.project_name ? data.project_name.toUpperCase() : 'BUSINESS PLAN'}
==================================================

${data.business_plan || 'No business plan generated.'}

==================================================
EXECUTION ROADMAP
==================================================

${(data.roadmap || []).map(r => `[${r.phase} - ${r.timeline}]\n${r.tasks.map(t => `- ${t}`).join('\n')}`).join('\n\n')}

==================================================
PRICING STRATEGY
==================================================

${(data.pricing_plan || []).map(p => `${p.name}: ${p.price}\nFeatures: ${p.features.join(', ')}`).join('\n\n')}
                    `;
                    filename = "business-plan.md";
                 }

                 const blob = new Blob([content], { type: 'text/plain' });
                 const url = window.URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = filename;
                 a.click();
                 window.URL.revokeObjectURL(url);
            } else {
                pendingExportType = type;
                document.getElementById('modal-license').classList.remove('hidden');
                document.getElementById('modal-license').classList.add('flex');
            }
        }
        function closeLicenseModal() {
            document.getElementById('modal-license').classList.add('hidden');
        }
        function validateKey() {
            const key = document.getElementById('license-key').value;
             if (key === 'GEMINI-2025') {
                localStorage.setItem('venture_auth', 'true');
                closeLicenseModal();
                alert("Premium Features Unlocked.");
                // Resume export if pending
                if(pendingExportType) {
                    handleExport(pendingExportType);
                    pendingExportType = null;
                }
            } else {
                document.getElementById('key-error').classList.remove('hidden');
            }
        }
        function resetSystem() {
            if(confirm('Reboot System?')) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>